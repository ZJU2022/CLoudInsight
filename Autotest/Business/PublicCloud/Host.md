# 主机自动化测试设计思路

## 概述

本文档详细描述了主机产品线的自动化测试设计思路，包括功能点梳理、自动化交付产物设计、测试策略制定以及具体实施方案。主机作为云基础设施的核心组件，其自动化测试需要覆盖从创建到销毁的完整生命周期。

## 第一步：功能点与实例类型梳理

### 实例类型分类

#### 1. 计算规格
- **快杰O型**: 计算、存储、网络性能卓越的旗舰云主机，支持x86和Arm架构
- **快杰PRO通用型**: 独享vCPU，无CPU资源竞争，适合渲染和游戏业务
- **快杰PRO增强型**: 3.5GHz顶级单核算力，适合高频交易和EDA
- **快杰内存型**: 大容量内存型，支持1:16超大CPU内存配比
- **快杰共享型**: CPU资源共享，高性价比，适合中小型应用
- **通用型N**: 上一代机型，配置灵活自由
- **高主频型C**: 3.2GHz以上主频，单核性能极佳
- **GPU型G**: 搭载Nvidia Tesla GPU，适合AI和科学计算

#### 2. 存储类型
- **RSSD云盘**: 快杰系列专用，最大120W IOPS性能
- **SSD云盘**: 高性能SSD存储
- **普通云盘**: 标准网络存储
- **本地盘**: 直接挂载到物理机的存储


#### 3. 网络配置
- **VPC网络**: 虚拟私有云网络
- **网络增强2.0**: 快杰系列支持，最大1000W PPS
- **网络增强1.0**: 上一代系列支持
- **内网带宽**: 快杰系列25GbE，上一代系列10GbE
- **弹性网卡**: 支持多网卡配置
- **带宽配置**: 按需带宽调整

#### 3. 操作系统
- **Linux系列**: CentOS、Ubuntu、Debian、Alpine
- **Windows系列**: Windows Server 2016/2019/2022
- **自定义镜像**: 用户自定义操作系统镜像

#### 5. CPU平台
- **Intel系列**: 
  - IvyBridge、Haswell、Broadwell、Skylake
  - Cascadelake、Cascadelake-Refresh、IceLake、SapphireRapids
- **AMD系列**: EPYC2 (Rome 7542、Rome 7H12、Rome 7F52)
- **Arm系列**: Ampere Altra (8030)

### 功能模块分类

#### 1. 主机管理模块
- **创建主机**: 多种配置创建
- **启动/停止**: 电源管理
- **重启**: 软重启和硬重启
- **删除主机**: 保留云盘删除
- **批量操作**: 批量创建、启动、停止、删除
- **规格变更**: CPU、内存规格调整
- **网络配置**: 弹性IP绑定/解绑、安全组配置、带宽调整
- **重装镜像**: 系统重装、镜像选择、数据保留策略

#### 2. 云盘管理模块
- **云盘创建**: 创建不同类型云盘（RSSD/SSD/普通云盘）
- **云盘挂载**: 挂载/卸载云盘到主机
- **云盘扩容**: 在线扩容和离线扩容
- **云盘快照**: 创建、删除、回滚云盘快照
- **云盘备份**: 数据备份和恢复
- **云盘性能**: IOPS和吞吐量测试

#### 3. 镜像管理模块
- **镜像创建**: 从主机创建自定义镜像
- **镜像导入**: 导入外部镜像
- **镜像复制**: 跨地域镜像复制
- **镜像共享**: 镜像共享和权限管理
- **镜像删除**: 镜像清理和版本管理
- **镜像兼容性**: 不同架构镜像兼容性测试

#### 4. 快照服务管理模块
- **云盘快照**: 创建、删除、回滚云盘快照
- **本地盘快照**: 创建、删除、回滚本地盘快照
- **快照一致性**: 快照数据一致性验证
- **快照链管理**: 快照链创建和维护
- **快照恢复**: 从快照恢复数据
- **快照性能**: 快照创建和恢复性能测试

#### 5. 密钥对管理模块
- **密钥对创建**: 生成SSH密钥对
- **密钥对导入**: 导入现有密钥对
- **密钥对绑定**: 绑定密钥对到主机
- **密钥对解绑**: 从主机解绑密钥对
- **密钥对删除**: 密钥对清理
- **密钥对权限**: 密钥对访问权限管理

#### 6. 硬件隔离组模块
- **隔离组创建**: 创建硬件隔离组
- **主机绑定**: 将主机绑定到隔离组
- **隔离组配置**: 隔离组策略配置
- **隔离组验证**: 验证硬件隔离效果
- **隔离组删除**: 隔离组清理

#### 7. 主机启动模板模块
- **模板创建**: 创建主机启动模板
- **模板配置**: 配置模板参数（镜像、规格、网络等）
- **模板使用**: 使用模板快速创建主机
- **模板更新**: 更新模板配置
- **模板删除**: 模板清理

#### 8. 虚拟网卡管理模块
- **虚拟网卡创建**: 创建虚拟网卡
- **虚拟网卡绑定**: 绑定虚拟网卡到主机
- **虚拟网卡解绑**: 从主机解绑虚拟网卡
- **虚拟网卡删除**: 删除虚拟网卡
- **虚拟网卡配置**: 网卡参数配置（IP、子网、安全组等）
- **虚拟网卡性能**: 网卡性能测试和验证

#### 9. 监控运维模块
- **监控指标**: CPU、内存、磁盘、网络使用率
- **告警配置**: 自定义告警规则
- **日志管理**: 系统日志收集和分析
- **性能测试**: 基准性能测试

#### 10. 安全功能模块
- **安全组**: 网络访问控制
- **密码重置**: 系统密码重置
- **安全加固**: 系统安全配置
- **访问控制**: 权限管理和访问审计

## 第二步：自动化交付产物设计

### 自动化交付策略

#### 1. 基础功能回归 + 关联集合模板
- **限时要求**: 45分钟内完成
- **并行测试**: 支持多个工作流同时运行
- **智能回归**: 
  - 当前改动影响的功能：运行细分场景
  - 未影响的功能：正常回归测试

#### 2. 关联集合模板设计
- **基础回归验证**: 覆盖主机基本功能
- **微服务覆盖**: 确保所有相关微服务正常启动
- **快速验证**: 发布时快速验证核心功能

#### 3. 回归测试工作流
设计十条核心工作流，根据发布可用区自动选择：
- 快杰系列：快杰O型/快杰PRO通用型/快杰PRO增强型/快杰内存型/快杰共享型
- 上一代系列：通用型N/高主频型C/GPU型G
- 存储类型：RSSD云盘/SSD云盘/普通云盘/本地盘
- 网络类型：经典网络/VPC网络
- 操作系统：Linux/Windows

## 第三步：测试策略制定

### 自动化测试架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    主机自动化测试架构                          │
├─────────────────────────────────────────────────────────────┤
├─────────────────────────────────────────────────────────────┤
│  测试场景层 (Test Scenarios)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 单机测试    │ │ 双机测试    │ │ 网络测试    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  功能测试层 (Functional Testing)                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 主机管理    │ │ 存储管理    │ │ 网络管理    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  基础设施层 (Infrastructure)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 云API调用   │ │ 网络连接    │ │ 数据验证    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```


### 核心测试流程设计

#### 1. 单机完整生命周期测试
```
创建主机 → 检查运行状态 → SSH连通性验证 → 功能测试 → 验证操作结果 → 清理资源
    ↓           ↓              ↓           ↓           ↓           ↓
  参数配置    状态检查       端口测试     重启/改配    规格验证     删除主机
  机型选择    初始化完成     网络连通     密码重置     数据持久     资源释放
  CPU平台     CloudInit     密钥登录     镜像制作     性能测试
```

#### 2. 双机网络连通性测试
```
创建双机 → 初始化验证 → 网络连通测试 → 性能基准测试 → 清理资源
    ↓         ↓           ↓              ↓            ↓
  相同配置   端口检查    内网Ping测试    带宽测试      删除主机
  不同可用区  系统就绪    外网Ping测试    延迟测试      释放资源
  网络配置    SSH连接     域名解析测试    丢包率测试
```

#### 3. 网络增强功能测试
```
基线验证 → 降级网络增强 → 降级后验证 → 升级网络增强 → 升级后验证 → 对比分析
    ↓          ↓            ↓            ↓            ↓           ↓
  性能基准    功能降级     性能对比      功能升级     性能对比     回归验证
  连通性测试   配置变更     连通性测试    配置变更     连通性测试   数据对比
  带宽测试     状态检查     带宽测试      状态检查     带宽测试     结论输出
```

### 测试分层设计

#### 1. 黑盒层测试
- **接口连续调用**: 模拟真实用户操作流程
- **配置场景构造**: 通过不同配置组合构造测试场景
- **异常场景设计**: 覆盖各种异常情况

#### 2. 灰盒层测试
- **微服务集成**: 验证服务间交互
- **资源一致性**: 确保资源在不同服务间的一致性
- **性能监控**: 监控关键性能指标

#### 3. 白盒层测试（较少）
- **代码分支覆盖**: 覆盖关键代码路径
- **资源调度逻辑**: 重点覆盖资源调度相关代码

#### 4. 平行层测试（例）
- **容灾自动化**: 
  - 物理机故障测试
  - 网络故障测试
  - 存储故障测试
- **网络测试**: 
  - iperf打流测试
  - 网络延迟测试
  - 带宽测试
- **性能测试**: 
  - sysbench基准测试
  - unixbench系统性能测试
  - fio磁盘性能测试
  - 圆周率计算测试
- **连通性测试**: 
  - SSH连接测试
  - RDP连接测试（Windows）
  - 端口连通性测试

### 详细测试步骤设计

#### 1. 单机完整生命周期测试步骤

**阶段一：环境准备** - 创建密钥对、获取镜像列表、配置VPC子网、防火墙规则

**阶段二：主机创建与初始化** - 创建云主机（机型/CPU平台/镜像/网络/数据盘/快照/密钥）、检查运行状态、等待初始化、验证SSH连通性、确认CloudInit完成

**阶段三：基础功能验证** - 网络连通性测试、密钥登录验证、主机属性修改、业务组修改、域名解析测试、软件源连通性测试

**阶段四：运维操作测试** - 关机/开机/重启操作、密码重置验证、镜像制作、系统重装、带宽升级

**阶段五：存储操作测试** - 获取磁盘ID、系统盘扩容至60G、数据盘扩容至100G、重启生效、数据写入验证、持久化验证

**阶段六：配置变更测试** - CPU/内存升级（2核4G→4核8G）、规格验证、SSD云盘挂载、RSSD挂载验证

**阶段七：故障模拟测试** - 强制断电、系统重装、数据持久性验证（系统盘数据丢失、数据盘数据保留）

**阶段八：配置回退与清理** - 配置降级（4C8G→1C1G）、网络增强关闭、主机删除、资源清理

#### 2. 双机网络连通性测试步骤

**阶段一：双机部署** - 创建双机（uhost-1/uhost-2，带2数据盘+快照+密钥）、检查初始化、验证SSH连通性、确认CloudInit完成

**阶段二：网络连通性验证** - 网络连通性测试、域名ping测试、host1 ping host2（外网/内网）、域名解析测试（dig baidu.com）、软件源连通性测试

**阶段三：性能基准测试** - 内网带宽测试（iperf）、网络延迟测试、丢包率测试、并发连接测试

#### 3. 网络增强功能测试步骤

**阶段一：基线验证** - 创建双机环境、建立性能基准（带宽/延迟/丢包率）、记录网络配置状态

**阶段二：降级测试** - 降级网络增强功能、验证降级后性能、对比性能差异、验证安全组规则继承

**阶段三：升级测试** - 升级网络增强功能、验证升级后性能、对比性能差异、验证功能回归基线

**阶段四：异常测试** - 强制中断升降级过程、验证回滚机制、高并发流量下升降级、检测业务影响

#### 4. 子网和网卡测试步骤

**阶段一：网络环境准备** - 创建子网、创建虚拟机网卡、绑定虚拟网卡到主机

**阶段二：网卡功能测试** - 上传初始化网卡脚本、主机ping网卡、检验网卡名称、测试网卡性能

**阶段三：NCCL测试** - 上传NCCL材料、测试NCCL功能、判断NCCL性能、验证多卡通信



