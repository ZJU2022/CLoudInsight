# 主机自动化测试设计思路

## 概述

本文档详细描述了主机产品线的自动化测试设计思路，包括功能点梳理、自动化交付产物设计、测试策略制定以及具体实施方案。主机作为云基础设施的核心组件，其自动化测试需要覆盖从创建到销毁的完整生命周期。

## 第一步：功能点与实例类型梳理

### 实例类型分类

#### 1. 计算规格
- **快杰O型**: 计算、存储、网络性能卓越的旗舰云主机，支持x86和Arm架构
- **快杰PRO通用型**: 独享vCPU，无CPU资源竞争，适合渲染和游戏业务
- **快杰PRO增强型**: 3.5GHz顶级单核算力，适合高频交易和EDA
- **快杰内存型**: 大容量内存型，支持1:16超大CPU内存配比
- **快杰共享型**: CPU资源共享，高性价比，适合中小型应用
- **通用型N**: 上一代机型，配置灵活自由
- **高主频型C**: 3.2GHz以上主频，单核性能极佳
- **GPU型G**: 搭载Nvidia Tesla GPU，适合AI和科学计算

#### 2. 存储类型
- **RSSD云盘**: 快杰系列专用，最大120W IOPS性能
- **SSD云盘**: 高性能SSD存储
- **普通云盘**: 标准网络存储
- **本地盘**: 直接挂载到物理机的存储


#### 3. 网络配置
- **VPC网络**: 虚拟私有云网络
- **网络增强2.0**: 快杰系列支持，最大1000W PPS
- **网络增强1.0**: 上一代系列支持
- **内网带宽**: 快杰系列25GbE，上一代系列10GbE
- **弹性网卡**: 支持多网卡配置
- **带宽配置**: 按需带宽调整

#### 3. 操作系统
- **Linux系列**: CentOS、Ubuntu、Debian、Alpine
- **Windows系列**: Windows Server 2016/2019/2022
- **自定义镜像**: 用户自定义操作系统镜像

#### 5. CPU平台
- **Intel系列**: 
  - IvyBridge、Haswell、Broadwell、Skylake
  - Cascadelake、Cascadelake-Refresh、IceLake、SapphireRapids
- **AMD系列**: EPYC2 (Rome 7542、Rome 7H12、Rome 7F52)
- **Arm系列**: Ampere Altra (8030)

### 功能模块分类

#### 1. 生命周期管理模块
- **创建主机**: 支持多种配置创建
- **启动/停止**: 主机电源管理
- **重启**: 软重启和硬重启
- **删除主机**: 支持保留云盘删除
- **批量操作**: 批量创建、启动、停止、删除

#### 2. 配置管理模块
- **规格变更**: CPU、内存规格调整
- **磁盘管理**: 
  - 挂载/卸载云盘
  - 磁盘扩容
  - 磁盘快照
- **网络配置**: 
  - 弹性IP绑定/解绑
  - 安全组配置
  - 带宽调整

#### 3. 监控运维模块
- **监控指标**: CPU、内存、磁盘、网络使用率
- **告警配置**: 自定义告警规则
- **日志管理**: 系统日志收集和分析
- **性能测试**: 基准性能测试

#### 4. 安全功能模块
- **安全组**: 网络访问控制
- **密钥对**: SSH密钥管理
- **密码重置**: 系统密码重置
- **安全加固**: 系统安全配置

## 第二步：自动化交付产物设计

### 自动化交付策略

#### 1. 基础功能回归 + 关联集合模板
- **限时要求**: 45分钟内完成（比数据库稍长，因为主机启动时间较长）
- **并行测试**: 支持多个工作流同时运行
- **智能回归**: 
  - 当前改动影响的功能：运行细分场景
  - 未影响的功能：正常回归测试

#### 2. 关联集合模板设计
- **基础回归验证**: 覆盖主机基本功能
- **微服务覆盖**: 确保所有相关微服务正常启动
- **快速验证**: 发布时快速验证核心功能

#### 3. 回归测试工作流
设计十条核心工作流，根据发布可用区自动选择：
- 快杰系列：快杰O型/快杰PRO通用型/快杰PRO增强型/快杰内存型/快杰共享型
- 上一代系列：通用型N/高主频型C/GPU型G
- 存储类型：RSSD云盘/SSD云盘/普通云盘/本地盘
- 网络类型：经典网络/VPC网络
- 操作系统：Linux/Windows

## 第三步：测试策略制定

### 测试分层设计

#### 1. 黑盒层测试
- **接口连续调用**: 模拟真实用户操作流程
- **配置场景构造**: 通过不同配置组合构造测试场景
- **异常场景设计**: 覆盖各种异常情况

#### 2. 灰盒层测试
- **微服务集成**: 验证服务间交互
- **资源一致性**: 确保资源在不同服务间的一致性
- **性能监控**: 监控关键性能指标

#### 3. 白盒层测试（较少）
- **代码分支覆盖**: 覆盖关键代码路径
- **资源调度逻辑**: 重点覆盖资源调度相关代码

#### 4. 平行层测试（例）
- **容灾自动化**: 
  - 物理机故障测试
  - 网络故障测试
  - 存储故障测试
- **网络测试**: 
  - iperf打流测试
  - 网络延迟测试
  - 带宽测试
- **性能测试**: 
  - sysbench基准测试
  - unixbench系统性能测试
  - fio磁盘性能测试
  - 圆周率计算测试
- **连通性测试**: 
  - SSH连接测试
  - RDP连接测试（Windows）
  - 端口连通性测试

### 测试场景示例

#### 完整测试流程示例
```
CreateHost → DescribeHost → StartHost → WaitForRunning → 
SSHConnect → InstallSoftware → CreateSnapshot → 
AttachDisk → FormatDisk → PerformanceTest → 
StopHost → DetachDisk → DeleteSnapshot → 
DeleteHost
```

#### Windows主机测试流程示例
```
CreateHost → DescribeHost → StartHost → WaitForRunning → 
RDPConnect → InstallSoftware → CreateSnapshot → 
AttachDisk → FormatDisk → PerformanceTest → 
StopHost → DetachDisk → DeleteSnapshot → 
DeleteHost
```

## 第四步：实施计划

### 1. 周会对齐机制
- **频率**: 每周定期拉会
- **参与方**: 测试团队与业务方
- **内容**: 对齐每个场景的具体细节
- **目标**: 确保测试场景与实际业务需求一致

### 2. 场景构造方法
- **接口连续调用**: 设计完整的业务流程
- **配置组合构造**: 通过不同配置组合构造特定场景
- **异常场景覆盖**: 设计各种异常情况的测试用例

### 3. 测试数据管理
- **模板化配置**: 提供标准化的测试配置模板
- **参数化设计**: 支持灵活的参数调整
- **数据隔离**: 确保测试数据不影响生产环境

### 4. 环境管理
- **测试环境**: 独立的测试环境
- **镜像管理**: 标准化的测试镜像
- **网络隔离**: 测试网络与生产网络隔离

## 具体功能模块示例

### 主机创建流程
1. **参数验证**: 验证创建参数的有效性
2. **资源检查**: 检查可用区资源是否充足
3. **镜像下载**: 下载指定的操作系统镜像
4. **网络配置**: 配置网络和安全组
5. **存储配置**: 配置系统盘和数据盘
6. **主机启动**: 启动主机并等待就绪

### 规格变更流程
1. **兼容性检查**: 检查新规格的兼容性
2. **资源预占**: 预占新规格所需资源
3. **停机变更**: 停止主机进行规格变更
4. **配置更新**: 更新主机配置
5. **重启验证**: 重启主机验证新配置

### 磁盘管理流程
1. **磁盘创建**: 创建指定大小的云盘
2. **磁盘挂载**: 将磁盘挂载到主机
3. **磁盘格式化**: 格式化磁盘文件系统
4. **数据读写**: 验证磁盘读写功能
5. **磁盘卸载**: 卸载磁盘并删除

## 质量保证

### 1. 测试覆盖率
- **功能覆盖率**: 确保所有功能模块都有测试覆盖
- **场景覆盖率**: 覆盖各种使用场景
- **异常覆盖率**: 覆盖各种异常情况

### 2. 性能指标
- **响应时间**: API响应时间要求
- **并发能力**: 支持的最大并发数
- **资源利用率**: 测试过程中的资源使用情况

### 3. 稳定性指标
- **成功率**: 测试用例的成功率
- **稳定性**: 长期运行的稳定性
- **可重复性**: 测试结果的可重复性

## 机型选择测试策略

### 快杰系列测试重点
- **网络性能测试**: 验证1000W PPS网络性能
- **存储性能测试**: 验证120W IOPS存储性能
- **CPU架构兼容性**: 测试x86和Arm架构的兼容性
- **内核版本要求**: 验证Linux内核版本≥4.19的要求

### 上一代系列测试重点
- **功能兼容性**: 确保与现有应用的兼容性
- **性能基准**: 建立性能基准线
- **迁移测试**: 测试从上一代到快杰系列的迁移

### GPU型测试重点
- **GPU驱动测试**: 验证Nvidia驱动安装和配置
- **CUDA性能测试**: 验证GPU计算性能
- **显存测试**: 验证GPU显存容量和性能
- **AI框架测试**: 验证TensorFlow、PyTorch等框架

## 总结

主机自动化测试设计采用分层测试策略，通过功能点梳理、自动化交付产物设计、测试策略制定和实施计划，构建了一个完整的自动化测试体系。该体系能够有效保障主机产品的质量，提高测试效率，支持快速迭代和发布。相比数据库产品，主机测试更注重资源管理、网络配置和性能测试，测试时间也相对较长。

特别针对UCloud的机型特点，测试策略需要重点关注快杰系列的高性能特性、上一代系列的兼容性保障，以及GPU型的专业计算能力验证。